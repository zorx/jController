(function(e){"use strict";function h(){if(i){d.clearCanvas()}d.renderAll();d.cleanAll();requestAnimFrame(h)}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();e.jController={};var t;var n;var r;var i=true;var s={};var o={};var u={};var a={};var f={};var l={};var c={};e.fn.jController=function(e){d.init(this,e);requestAnimFrame(h);return this};var p=function(t,n,r){this.id=r;this.attr=t;this.isRender=false;this.setInternal=function(t){var i=e.isPlainObject(s[n+r])?s[n+r]:{};s[n+r]=e.extend(true,{},i,t)};this.getInternal=function(t){return e.isPlainObject(s[n+r])?s[n+r][t]:undefined};this.getInternals=function(){return s[n+r]};this.render=function(t,n){if(!e.isPlainObject(u[t])){u[t]={instances:[]}}var r=u[t].instances.length;var i=new p(e.jController.getPlugin(t).construct(n),t,r);u[t].instances.push(i);return i};this.remove=function(){o[n].instances[r]=undefined;if(e.isPlainObject(l[n])){e.each(l[n][r],function(t,i){e.jController.getListener(t).off(l[n][r][t])})}};this.trigger=function(t,r){var i=p[t];if(e.jController.isEvent(n,t)&&e.isFunction(i)){var s=e.jController.getPlugin(n).events[t].fn;s(this,i,r)}};this.parent=function(){return o[n]}};var d={init:function(i,s){var o="jController_"+e("canvas").length;t=e("<canvas>").attr(s.attr).attr({id:o}).appendTo(i);n=t[0];r=n.getContext("2d");e.each(s.events,function(e,t){c[e]=t})},listenEvents:function(t,n){e.each(t.attr,function(r,i){if(e.jController.isEvent(n,r)&&e.isFunction(i)){var s=r;var o=i;var u=e.jController.getPlugin(n).events[s].listener;var a=e.jController.getPlugin(n).events[s].fn;if(u!=undefined){if(!e.isPlainObject(l[n])){l[n]={}}if(!e.isPlainObject(l[n][t.id])){l[n][t.id]={}}l[n][t.id][u]=function(e){a(t,o,e)};if(e.jController.isListener(u)){e.jController.getListener(u).on(l[n][t.id][u])}else{throw"jController error: can't find <"+u+"> listener"}}}})},cleanAll:function(){u={}},clearCanvas:function(){e.jController.getContext().clearRect(0,0,e.jController.getCanvas().width,e.jController.getCanvas().height)},renderAll:function(){e.each(o,function(t,n){e.each(n.instances,function(e,r){if(r!=undefined){if(!r.isRender){d.listenEvents(r,t);r.isRender=true}n.render(r)}})});d.renderEphemeral()},renderEphemeral:function(){var t=false;e.each(u,function(n,r){t=true;e.each(r.instances,function(r,i){if(i!=undefined){if(!i.isRender){t=false;d.listenEvents(i,n);i.isRender=true}e.jController.getPlugin(n).render(i)}})});if(!t){d.renderEphemeral()}}};e.jController.import=function(t,n){(function r(t,n){if(t.length==0){n()}else{e.getScript(t[0],function(){r(t.slice(1),n)}).fail(function(e,t,n){throw"jController error: on import, "+n})}})(e.makeArray(t),n)};e.jController.getCanvasObject=function(){return t};e.jController.getCanvas=function(){return n};e.jController.getContext=function(){return r};e.jController.clearCanvas=function(e){i=e};e.jController.trigger=function(t,n){var r=c[t];if(e.isFunction(r)){r(n)}};e.jController.getListeners=function(){return f};e.jController.getListener=function(e){return f[e]};e.jController.isListener=function(t){return e.isPlainObject(f[t])&&e.isFunction(f[t].on)&&e.isFunction(f[t].off)};e.jController.registerListener=function(e){if(e.name){f[e.name]={on:e.on,off:e.off}}};e.jController.getHelpers=function(){return a};e.jController.getHelper=function(e){return a[e]};e.jController.isHelper=function(t){return e.isFunction(a[t])};e.jController.registerHelper=function(e){if(e.name){a[e.name]=e.fn}};e.jController.getEvents=function(t){return e.jController.isPlugin(t)&&e.isPlainObject(e.jController.getPlugin(t).events)?e.jController.getPlugin(t).events:null};e.jController.getEvent=function(t,n){return e.jController.isEvent(t,n)?o[t].events[n]:null};e.jController.isEvent=function(t,n){return e.jController.isPlugin(t)&&e.isPlainObject(o[t].events)&&e.isPlainObject(o[t].events[n])&&e.isFunction(o[t].events[n].fn)};e.jController.getPlugins=function(){return o};e.jController.getPlugin=function(e){return o[e]};e.jController.isPlugin=function(t){return e.isPlainObject(o[t])};e.jController.registerPlugin=function(t){var n=t.name;if(!n){throw"jController error: can't register plugin without name !"}var r={instances:[],getEvent:function(t){return e.jController.getEvent(n,t)},isEvent:function(t){return e.jController.isEvent(n,t)}};o[n]=e.extend(true,{},r,t);e.jController[n]=function(e){var r=o[n].instances.length;var i=new p(t.construct(e),n,r);o[n].instances.push(i);return i}}})(jQuery)